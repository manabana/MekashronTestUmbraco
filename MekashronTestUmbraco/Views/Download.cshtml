@using System.Globalization
@using Umbraco.Cms.Web.Common.PublishedModels;
@using System.Text.Json

@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage

@{
    Guid indexPageId = Guid.Parse("41e0ccdd-4a1d-4aa8-a022-abc7d5555024");
    IPublishedContent? indexPage = Umbraco.Content(indexPageId);
    if (indexPage is null) throw new Exception("index page not found");

    Guid downloadCallCenterV7PageId = Guid.Parse("0f2be95e-e05f-4450-afe9-58141217c704");
    IPublishedContent? downloadCallCenterV7Page = Umbraco.Content(downloadCallCenterV7PageId);
    if (downloadCallCenterV7Page is null) throw new Exception("downloadCallCenterV7 Page not found");
    String currentLang = CultureInfo.CurrentUICulture.Name ?? "en";
    String downloadCallCenterV7PageUrl = downloadCallCenterV7Page.Url(currentLang);
}


<!DOCTYPE html>
<html lang="en">

@await Html.PartialAsync("Partials/Head")

<body>
    <div class="site" id="page">

        @await Html.PartialAsync("Partials/Header")

        <main class="main" id="primary">
            <section class="breadcrumbs">
                <div class="container">
                    <h1 style="text-align: center; ">@Model.Value("title")</h1>
                </div>
            </section>
            <section class="info">
                <div class="container">
                    <p style="text-align: center;">
                        @Html.Raw(Model.Value<String>("description")?.Replace("\n", "<br>"))
                    </p>
                    <p style="text-align: center; color: #800000;">
                        @Model.Value("warningText")
                    </p>
                    <form id="registerForm">
                        <div class="form-group">
                            <label for="name">@Model.Value("NameField")</label>
                            <input type="text" id="name" name="Name">
                        </div>
                        <div class="form-group">
                            <label for="company">@Model.Value("CompanyNameField")</label>
                            <input type="text" id="company" name="Company">
                        </div>
                        <div class="form-group">
                            <label for="phone">@Model.Value("PhoneField")</label>
                            <input type="tel" id="phone" name="Phone">
                        </div>
                        <div class="form-group">
                            <label for="email">@Model.Value("EmailField")</label>
                            <input type="email" id="email" name="Email">
                        </div>
                        <button class="button button--accent" type="submit">@Model.Value("submit")</button>
                    </form>

                    <div id="registerResult" style="margin-top:16px;color:#003300"></div>
                </div>
            </section>
        </main>

        @await Html.PartialAsync("Partials/Footer")

    </div>

    <script src="@(Url.Content("~/assets/js/jquery-3.7.1.min.js"))"></script>
    <script src="@(Url.Content("~/assets/js/swiper-bundle.min.js"))"></script>
    <script src="@(Url.Content("~/assets/js/select.js"))"></script>
    <script src="@(Url.Content("~/assets/js/scripts.js"))"></script>

    <script>
        const WordsDictionary = {
            nameRequired: @Html.Raw(JsonSerializer.Serialize(Model.Value("NameRequired"))),
            companyRequired: @Html.Raw(JsonSerializer.Serialize(Model.Value("CompanyRequired"))),
            phoneNumberEmpty: @Html.Raw(JsonSerializer.Serialize(Model.Value("PhoneNumberEmpty"))),
            phoneNumberInvalid: @Html.Raw(JsonSerializer.Serialize(Model.Value("PhoneNumberInvalid"))),
            emailRequired: @Html.Raw(JsonSerializer.Serialize(Model.Value("EmailRequired"))),
            sending: @Html.Raw(JsonSerializer.Serialize(Model.Value("sending"))),
            networkError: @Html.Raw(JsonSerializer.Serialize(Model.Value("NetworkError"))),
            submitText: @Html.Raw(JsonSerializer.Serialize(Model.Value("submit"))),
            downloadingFailed: @Html.Raw(JsonSerializer.Serialize(Model.Value("DownloadingFailed"))),
            unknownError: @Html.Raw(JsonSerializer.Serialize(Model.Value("UnknownError")))
        };

        const downloadCallCenterPageUrl = @Html.Raw(JsonSerializer.Serialize(downloadCallCenterV7PageUrl));
    </script>


    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const form = document.getElementById('registerForm');
            if (!form) return;

            const phoneRegex = /^\+?[1-9][0-9]{7,14}$/;

            function isWhiteSpace(value) {
                return !value || value.trim().length === 0;
            }

            function clearErrors() {
                form.querySelectorAll('.error-text').forEach(e => e.remove());
                form.querySelectorAll('input').forEach(i => {
                    i.style.border = '';
                    i.style.backgroundColor = '';
                });
            }

            function showError(input, message) {
                const error = document.createElement('div');
                error.className = 'error-text';
                error.textContent = message;

                error.style.color = '#800000';
                error.style.fontSize = '13px';
                error.style.marginTop = '6px';

                input.style.border = '2px solid #800000';
                input.style.backgroundColor = '#fff5f5';

                input.parentNode.appendChild(error);
            }

            ['input', 'change'].forEach(evt => {
                form.addEventListener(evt, e => {
                    const input = e.target;
                    if (!(input instanceof HTMLInputElement)) return;

                    const err = input.parentNode.querySelector('.error-text');
                    if (!err) return;

                    input.style.border = '';
                    input.style.backgroundColor = '';
                    err.remove();
                });
            });

            form.addEventListener('submit', async function (e) {
                e.preventDefault();
                clearErrors();

                let hasErrors = false;

                const name = form.querySelector('[name="Name"]');
                const company = form.querySelector('[name="Company"]');
                const phone = form.querySelector('[name="Phone"]');
                const email = form.querySelector('[name="Email"]');

                if (isWhiteSpace(name.value)) {
                    showError(name, WordsDictionary.nameRequired);
                    hasErrors = true;
                }

                if (isWhiteSpace(company.value)) {
                    showError(company, WordsDictionary.companyRequired);
                    hasErrors = true;
                }

                if (isWhiteSpace(phone.value)) {
                    showError(phone, WordsDictionary.phoneNumberEmpty);
                    hasErrors = true;
                }
                else if (!phoneRegex.test(phone.value)) {
                    showError(phone, WordsDictionary.phoneNumberInvalid);
                    hasErrors = true;
                }

                if (isWhiteSpace(email.value)) {
                    showError(email, WordsDictionary.emailRequired);
                    hasErrors = true;
                }

                if (hasErrors) return;

                const data = {
                    Name: name.value.trim(),
                    Company: company.value.trim(),
                    Phone: phone.value.trim(),
                    Email: email.value.trim()
                };

                const btn = form.querySelector('button[type="submit"]');
                btn.disabled = true;
                btn.textContent = WordsDictionary.sending;

                const resultDiv = document.getElementById('registerResult');

                try {
                    const res = await fetch('/api/register', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });

                    if (!res.ok) {
                        const err = await res.json().catch(() => ({ error: WordsDictionary.unknownError }));
                        resultDiv.style.color = '#800000';
                        resultDiv.textContent = err.error || err.message;
                    }
                    else {
                        const json = await res.json();
                        resultDiv.style.color = '#003300';
                        resultDiv.textContent = 'Success';

                        window.location.href = downloadCallCenterPageUrl;
                    }
                }
                catch (ex) {
                    resultDiv.style.color = '#800000';
                    resultDiv.textContent = WordsDictionary.networkError;
                }
                finally {
                    btn.disabled = false;
                    btn.textContent = WordsDictionary.submitText;
                }
            });
        });
    </script>

    <script>
        async function downloadFile(url) {
            const res = await fetch(url, { method: 'GET' });

            if (!res.ok) {
                throw new Error('downloading failed');
            }

            const blob = await res.blob();
            const downloadUrl = window.URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = downloadUrl;

            a.download = 'mekashronCallCenterV7.exe';

            document.body.appendChild(a);
            a.click();

            a.remove();
            window.URL.revokeObjectURL(downloadUrl);
        }
    </script>

</body>

</html>